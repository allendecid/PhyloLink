function makemap(a,b){function m(){var a=d3.select("#hiddinx");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function o(){d3.csv("file://"+b,function(b){d3.text("file://"+a,function(a){function v(a,b,c){return a.replace(new RegExp(w(b),"g"),c)}function w(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function x(a,b){var c=function(a,b){if(b(a),a.children)for(var d=a.children.length-1;d>=0;d--)c(a.children[d],b)};c(a[0],function(a){a.rootDist=(a.parent?a.parent.rootDist:0)+(a.branchlength||0)});var d=a.map(function(a){return a.rootDist}),e=d3.scale.linear().domain([0,d3.max(d)]).range([0,b]);return c(a[0],function(a){a.y=e(a.rootDist)}),e}function z(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(y).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(y)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("font-size","9").attr("font-family","sans-serif").attr("fill","#fff").attr("text-anchor","middle").text(function(a){return a.key})}function B(a,b){return a.children&&(a.depth===b-1&&a.state.length>1?a.state=a.children[0].branchlength>a.children[1].branchlength?a.children[1].state:a.children[0].state:a.children.forEach(function(a){B(a,b)})),a}function C(a){function b(a){a.children&&(a.children.reverse(),a.children.forEach(function(c){c.state.length>1&&1===a.state.length&&(c.state=a.state),b(c)}))}return b(a),a}function D(a){function b(a){a.children&&(a.ml=0,a.children.forEach(function(c){c.state.length>1&&(c.state=c.state.concat(a.state),K(c.state)?(c.p=2/c.state.length,c.state=M(c.state)):(c.state=M(c.state),c.p=1/c.state.length)),b(c)}))}return b(a),a}function E(a,b){function c(a,b){if(a.children){var d=a.ml.indexOf(Math.max.apply(Math,a.ml));a.state=[b[d]],a.p="undefined";var e=d3.max(a.ml);a.D=-2*Math.log(e/d3.sum(a.ml)),a.children.forEach(function(a){c(a,b)})}}return c(a,b),a}function F(a,b,c,f){if(a.children)t+=a.branchlength,a.depth=b,a.ml=[],a.ltotal=a.branchlength+c,a.children.forEach(function(c){F(c,b+1,a.ltotal,f)});else{d+=2,a.depth=b,s.push(b),a.state=[e[a.name]],a.ltotal=a.branchlength+c,a.p=1,a.ml=[];var g=f.length;for(a.D="undefined",1/g+(g-1)/g*Math.exp(-g),1/g-1/g*Math.exp(-g),Q=0;g>Q;Q++)a.ml.push(0);var k=h.indexOf(a.state[0]);a.ml[k]=1,t+=a.branchlength}return a}function G(a,b,c){return a.children&&(a.depth===b-1?(a.children.reverse(),a.ml=J(a,c)):a.children.forEach(function(a){G(a,b,c)})),a}function H(a,b){if(a.children)if(a.depth===b-1){var c=I(a);a.state=c[0],a.p=c[1]}else a.children.forEach(function(a){H(a,b)});return a}function I(a){var c,b=[];return b=a.children[0].state.concat(a.children[1].state),K(b)?(c=2/b.length,b=M(b)):c=1/b.length,[b,c]}function J(a,b){var c=[],d=b.length,e=1/d+(d-1)/d*Math.exp(-d*a.children[0].branchlength/t),f=1/d+(d-1)/d*Math.exp(-d*a.children[1].branchlength/t),g=1/d-1/d*Math.exp(-d*a.children[0].branchlength/t),h=1/d-1/d*Math.exp(-d*a.children[1].branchlength/t);for(Q=0;d>Q;Q++){var i=0;for(j=0;d>j;j++)if(j===Q)for(k=0;d>k;k++)i+=k===j?e*a.children[0].ml[j]*f*a.children[1].ml[k]:e*a.children[0].ml[j]*h*a.children[1].ml[k];else for(k=0;d>k;k++)i+=k===Q?g*a.children[0].ml[j]*f*a.children[1].ml[k]:g*a.children[0].ml[j]*h*a.children[1].ml[k];c.push(i)}return c}function K(a){for(var b=0;b<=a.length;b++)for(var c=b;c<=a.length;c++)if(b!=c&&a[b]==a[c])return!0;return!1}function M(a){var b={},c=[],d=0;for(var e in a)a[e]in b||(b[a[e]]=0),b[a[e]]++,b[a[e]]==d?c.push(a[e]):b[a[e]]>d&&(d=b[a[e]],c=[a[e]]);return c}function R(){var a=d3.select("#barrah");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function S(){var a=d3.select("#esconde");"visible"==a.style("visibility")?a.style("visibility","hidden"):a.style("visibility","visible")}b.forEach(function(a){e[a[l[0]]]=a[l[1]],a.close=+a.close}),h=d3.map(b,function(a){return a[l[1]]}).keys();var t,c=a,f=v(c," ",""),i=nwk.parser.parse(f),m=nwk.converter.toBinary(i),n=nwk.converter.toJSON(m),o=v(n,',"children":[]',""),r=JSON.parse(o),s=[];PhyloAng=function(){function c(c){var e=c.source,f=c.target,i=((e.x+f.x)/2,(e.y+f.y)/2,[e,{x:f.x,y:e.y},f]);return i=i.map(a),b(i)}var a=function(a){return[a.y,a.x]},b=function(a){return"M"+a[0]+" "+a[1]+" "+a[2]};return c.projection=function(b){return arguments.length?(a=b,c):a},c.path=function(a){return arguments.length?(b=a,c):b},c},Phylocor=function(a,b){var c=2*Math.PI,d=c/4,e=a[0]>=0?a[1]>=0?1:2:a[1]>=0?4:3,f=Math.abs(Math.asin(a[1]/b));switch(e){case 1:coordAngle=d-f;break;case 2:coordAngle=d+f;break;case 3:coordAngle=2*d+d-f;break;case 4:coordAngle=3*d+f}return coordAngle},Phylonodes=function(a){a.selectAll("g.leaf.node").append("svg:circle").attr("r",5).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.inner.node").append("svg:circle").attr("r",3.5).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.root.node").append("svg:circle").attr("r",6).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px")},Phylodo=function(a,b,c){function r(){q.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),q.selectAll("path.link").attr("stroke-width",1.5/o.scale())}s=[];var e=h;t=0;var f=F(a,1,0,e),i=d3.max(s);if(0===b){a.ltotal=0;for(var j=i;j>0;j--)var a=H(f,j);a=D(a),$("#btnSubmitm1").html("ML")}else{a.ltotal=0;for(var j=i;j>0;j--)var a=G(f,j,e);a=E(a,e),$("#btnSubmitm1").html("Linear")}if(1===c)for(var j=i;j>0;j--)a=B(f,j);2===c&&C(a);var k=$(document).height();9*d>$(document).height()&&(k=9*d);var l=$(document).width(),m=k,n=d3.layout.cluster().size([m,l]).sort(function(a){return a.children?a.children.length:-1}).children(function(a){return a.children}),o=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",r),p=PhyloAng(),q=d3.select("#arbol").append("svg:svg").attr("width",l+300).attr("height",m+50).attr("class","overlay").call(o).append("svg:g").attr("transform","translate(20, 20)"),a=n(a);x(a,l),q.selectAll("path.link").data(n.links(a)).enter().append("svg:path").attr("class","link").attr("d",p).attr("stroke",function(a){return a.target.state.length>1?"#ccc":g(a.target.state)}).attr("stroke-width","1.5px"),q.selectAll("g.node").data(a).enter().append("svg:g").attr("class",function(a){return a.children?0==a.depth?"root node":"inner node":"leaf node"}).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).on("mouseover",function(a){z.transition().duration(200).style("opacity",.9),z.html("State: "+a.state+"<br >"+"P: "+a.p+"<br >"+"D(Ltest): "+a.D).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){z.transition().duration(500).style("opacity",0)});var z=d3.select("#arbol").append("div").attr("class","tooltip").style("opacity",0);return Phylonodes(q),q.selectAll("g.inner.node").append("svg:text").attr("dx",-6).attr("dy",-6).attr("text-anchor","end").attr("font-size","5").attr("fill","#606060 ").text(function(a){return a.name}),q.selectAll("g.leaf.node").append("svg:text").attr("dx",8).attr("dy",3).attr("text-anchor","start").attr("font-size","7").attr("fill",function(){return"black"}).text(function(a){return a.name}),{tree:n,vis:q}},Phylodo(r,0,0);var y={"":"Transparent",undefined:"#ccc"};for(Q=0;Q<h.length;Q++)y[h[Q]]=g(h[Q]);z();var Q=0;$(document).ready(function(){$("#btnSubmitm").click(function(){d3.select("#arbol").selectAll("svg").remove(),R(),p(r),S()}),$("#btnSubmitm1").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,"ML"===$(this).text()?Phylodo(r,1,0):Phylodo(r,0,0)}),$("#btnSubmitm2").click(function(){window.location.reload(!0)}),$("#btnSubmitm3").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,Phylodo(r,0,1)}),$("#btnSubmitm4").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,Phylodo(r,0,2)}),$("#btnSubmitm5").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,R(),q(r),S()})})})})}function p(a){var b={},c={},d=[];for(i=0;i<h.length;i++)f[h[i]]=[],c[h[i]]=g(h[i]);c.defaultFill="#bdbdbd",d3.csv("uploads/Countrycode.csv",function(e){function m(a){function e(a){if(a.children){var f=n(a);if("undefined"!=typeof f)for(i=0;i<f.length;i++)f[i]!==a.state[0]&&(c.push({origin:{latitude:b[a.state][0],longitude:b[a.state][1]},destination:{latitude:b[f[i]][0],longitude:b[f[i]][1]},options:{strokeColor:g(a.state)},pais:a.state,dist:a.ltotal}),j.push({name:a.state,latitude:b[f[i]][0],longitude:b[f[i]][1],radius:15,fillKey:a.state,dist:a.ltotal}));a.children.forEach(function(a){e(a)})}else d.push({A:a.ltotal,B:a.state})}var c=[];return e(a),c}function n(a){function c(a){a.children&&a.children.forEach(function(c){a.state.length<2&&a.state!==c.state&&(b=b.concat(c.state))})}var b=[];return c(a),b}function p(){for(i=0;i<h.length;i++)o[h[i]]=0}function B(a){d3.select("#nRadius-value").text(k[a-1].dist.toFixed(5)),y.arc(k.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(j.slice(0,a)),a<k.length&&window.setTimeout(function(){B(++a)},k[a-1].dist*A)}function C(a){d3.select("#nRadius-value1").text((s+t*a).toFixed(5)),y.bubbles(q.slice(0,a*h.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}}),a<q.length/h.length&&window.setTimeout(function(){C(++a)},300)}function D(a){0!==a?(d3.select("#nRadius-value").text(k[a-1].dist.toFixed(5)),y.arc(k.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(j.slice(0,a))):y.arc([])}function E(a){d3.select("#nRadius-value1").text((s+t*a).toFixed(3)),y.bubbles(q.slice(0,a*h.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}})}var f;"1"===l[2]?f="Country":"2"===l[2]?f="two":"3"===l[2]&&(f="three"),e.forEach(function(a){b[a[f]]=[a.Latitude,a.Longitude],a.close=+a.close});var j=[],k=m(a),o={},q=[];p(),d.sort(function(a,b){return a.A-b.A});var r=d[d.length-1].A,s=d[0].A,t=(r-s)/40,u=1,v=25*h.length/d.length;d.forEach(function(a){if(a.A<=s+t*u)o[a.B]+=1;else for(u++,i=0;i<h.length;i++)q.push({name:h[i],latitude:b[h[i]][0],longitude:b[h[i]][1],radius:5+o[h[i]]*v,fillKey:h[i],cant:o[h[i]]})});var w=0,x=0;j.forEach(function(a){w+=parseInt(a.latitude),x+=parseInt(a.longitude)}),w/=j.length,x/=j.length;var y=new Datamap({element:document.getElementById("arcs"),geographyConfig:{popupOnHover:!1},scope:"world",setProjection:function(a){var b=d3.geo.mercator().center([x,w]).scale(500).translate([a.offsetWidth/2,a.offsetHeight/2]),c=d3.geo.path().projection(b);return{path:c,projection:b}},fills:c,done:function(a){function b(){a.svg.selectAll("g").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}a.svg.call(d3.behavior.zoom().on("zoom",b))}});k.sort(function(a,b){return a.dist-b.dist}),j.sort(function(a,b){return a.dist-b.dist}),$("#nRadius").attr("min",0),$("#nRadius").attr("max",k.length),$("#nRadius1").attr("max",q.length/h.length);var z=d3.max(k,function(a){return+a.dist}),A=1e3/z;$(document).ready(function(){$("#play").click(function(){B(1)}),$("#play1").click(function(){C(1)})}),d3.select("#nRadius").on("input",function(){D(+this.value)}),d3.select("#nRadius1").on("input",function(){E(+this.value)})})}function q(a){function s(a){function c(a,d,e){a.children&&(a.code="papa",a.children.forEach(function(a){a.con=[],a.branchlength+=e,a.con=a.state,b.push(a),c(a,d+1,a.branchlength)})),a.depth=d}var b=[];return c(a,1,0),b}$("p").hide(),a=s(a),a.sort(function(a,b){return d3.ascending(a.branchlength,b.branchlength)});var c=[],d=[],e=[];h.forEach(function(a){c[a]=0,d[a]=0,e[a]=0});var f=[];a.forEach(function(a){f.push(a.branchlength);for(var b=0;b<a.con.length;b++)d[a.con[b]]+=1,c[a.con[b]]=(a.ltotal-e[a.con[b]])*d[a.con[b]]*((d[a.con[b]]-1)/2),e[a.con[b]]=a.ltotal,a.y=c[a.con[b]]});var i={top:20,right:80,bottom:30,left:150},j=900-i.left-i.right,k=500-i.top-i.bottom,l=d3.scale.linear().range([0,j]),m=d3.scale.linear().range([k,0]),n=d3.svg.axis().scale(l).orient("bottom"),o=d3.svg.axis().scale(m).orient("left"),p=d3.svg.line().interpolate("step-before").x(function(a){return l(a.date)}).y(function(a){return m(a.temp)}),q=d3.select("#arbol").append("svg").attr("width",j+i.left+i.right).attr("height",k+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")");data=a.map(function(a){return{city:a.con,date:a.branchlength,temp:a.y}}),data=d3.nest().key(function(a){return a.city}).entries(data),l.domain([0,d3.max(data,function(a){return d3.max(a.values,function(a){return a.date})})]),m.domain([0,d3.max(data,function(a){return d3.max(a.values,function(a){return a.temp})})]),q.append("g").attr("class","x axis").attr("transform","translate(0,"+k+")").call(n).append("text").attr("x",j).attr("y",30).style("text-anchor","end").text("Distance"),q.append("g").attr("class","y axis").call(o).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Count");var r=q.selectAll(".city").data(data,function(a){return a.key}).enter().append("g").attr("class","city");r.append("path").attr("class","line").attr("d",function(a){return p(a.values)}).style("stroke",function(a){return g(a.key)})}var c,h,d=0,e=[],f=[],g=d3.scale.category20(),l=[];d3.csv("file://"+b,function(a){c=Object.keys(a[0]),select=document.getElementById("countries"),select1=document.getElementById("countries1");for(key in c)select.add(new Option(c[key])),select1.add(new Option(c[key]));$(document).ready(function(){$("#btnSubmit1").click(function(){var a=$("#frm2 select");ci=0,a.each(function(){$(this).val()&&"Start"!==$(this).val()&&"3"!==$(this).val()&&(l[ci]=$(this).val(),ci++)}),o(),m()})})})}
