function Phylogen(a,b,c,d,e,f){function i(){var a=d3.select("#hiddin");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function k(e){d3.csv("file://"+d,function(d){1===e&&d.forEach(function(a){"undefined"!=typeof j[1]&&(h[a[j[0]]]=a[j[1]]),a.close=+a.close}),d3.text("file://"+a,function(a){function q(a,b,c){return a.replace(new RegExp(r(b),"g"),c)}function r(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function s(a,b){var c=function(a,b){if(b(a),a.children)for(var d=a.children.length-1;d>=0;d--)c(a.children[d],b)};c(a[0],function(a){a.rootDist=(a.parent?a.parent.rootDist:0)+(a.branchlength||0)});var d=a.map(function(a){return a.rootDist}),e=d3.scale.linear().domain([0,d3.max(d)]).range([0,b]);return c(a[0],function(a){a.y=e(a.rootDist)}),e}function t(a){function f(a,b,d,i){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){if(a.branchlength>=e)if(a.children){a.group=a.id,a.tagged=a.id;var j=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[j].children,1,b[j])}else;else a.branchlength<e&&(c.size+=1,a.children||(c.cnames=c.cnames+a.name+"\n",c.inside.push(h[a.name])),f(a,b,0,i))})):1===d&&a.children&&(a.code="papa",a.children.forEach(function(a){if(a.branchlength>=e)if(a.children){a.group=a.id,a.tagged=a.id;var d=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[d].children,1,b[d])}else;else a.branchlength<e&&(i.size+=1,a.children||(i.cnames=i.cnames+a.name+"\n",i.inside.push(h[a.name])),f(a,b,1,i))}))}var c={id:169,name:"",branchlength:0,size:0,inside:[],cnames:[],children:[]};g=0;var e=b;return f(a,c.children,0,c),c}function u(a){function f(a,b,i,j){0===i?a.children&&(a.code="papa",a.children.forEach(function(a){if(a.branchlength>=e)if(a.children){a.group=a.id,a.tagged=a.id;var k=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[k].children,1,b[k])}else a.group=d,d-=1,a.tagged=-a.id,b.push(a),g+=2;else a.branchlength<e&&(c.size+=1,a.children||(c.cnames=c.cnames+a.name+"\n",c.inside.push(h[a.name])),f(a,b,0,j))})):1===i&&a.children&&(a.code="papa",a.children.forEach(function(a){if(a.branchlength>=e)if(a.children){a.group=a.id,a.tagged=a.id;var i=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[i].children,1,b[i])}else a.group=d,d-=1,a.tagged=-a.id,b.push(a),g+=2;else a.branchlength<e&&(j.size+=1,a.children||(j.cnames=j.cnames+a.name+"\n",j.inside.push(h[a.name])),f(a,b,1,j))}))}var c={id:169,name:"",branchlength:0,size:0,inside:[],cnames:[],children:[]};g=0;var d=-1,e=b;return f(a,c.children,0,c),c}function v(a){function f(a,b,d,i){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){if(a.children)if(a.branchlength>=e){a.group=a.id,a.tagged=a.id;var j=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[j].children,1,b[j])}else a.branchlength<e&&f(a,b,0,i);else c.cnames=c.cnames+a.name+"\n",c.inside.push(h[a.name]),c.size+=1})):1===d&&a.children&&(a.code="papa",a.children.forEach(function(a){if(a.children)if(a.branchlength>=e){a.group=a.id,a.tagged=a.id;var d=b.push({id:a.id,name:a.name,branchlength:a.branchlength,tagged:a.id,size:0,inside:[],cnames:[],children:[]})-1;g+=2,f(a,b[d].children,1,b[d])}else a.branchlength<e&&f(a,b,1,i);else i.cnames=i.cnames+a.name+"\n",i.inside.push(h[a.name]),i.size+=1}))}var c={id:169,name:"",branchlength:0,size:0,inside:[],cnames:[],children:[]};g=0;var e=b;return f(a,c.children,0,c),c}function w(a){var d,b=[],c=[];a.sort();for(var e=0;e<a.length;e++)a[e]!==d?(b.push(a[e]),c.push(1)):c[c.length-1]++,d=a[e];return[b,c]}var d=a,i=q(d," ",""),j=nwk.parser.parse(i),k=nwk.converter.toBinary(j),m=nwk.converter.toJSON(k),n=q(m,',"children":[]',""),o=JSON.parse(n);"1"===f?($("#openert").on("click",function(){$(this).prop("disabled",!0)}),o=v(o)):($(document).ready(function(){$("#openert").click(function(){l()})}),o="0"===c?t(o):u(o));var p=d3.scale.category20();Phylodiag=function(){function c(c){var e=c.source,f=c.target,i=((e.x+f.x)/2,(e.y+f.y)/2,[e,{x:f.x,y:e.y},f]);return i=i.map(a),b(i)}var a=function(a){return[a.y,a.x]},b=function(a){return"M"+a[0]+" "+a[1]+" "+a[2]};return c.projection=function(b){return arguments.length?(a=b,c):a},c.path=function(a){return arguments.length?(b=a,c):b},c},Phylocord=function(a,b){var c=2*Math.PI,d=c/4,e=a[0]>=0?a[1]>=0?1:2:a[1]>=0?4:3,f=Math.abs(Math.asin(a[1]/b));switch(e){case 1:coordAngle=d-f;break;case 2:coordAngle=d+f;break;case 3:coordAngle=2*d+d-f;break;case 4:coordAngle=3*d+f}return coordAngle},PhyloNodes=function(a){a.selectAll("g.leaf.node").append("svg:circle").attr("r",function(a){return a.size?3+3*Math.log(a.size):4}).attr("fill",function(a){return a.tagged?p(a.tagged):void 0}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.inner.node").append("svg:circle").attr("r",function(a){return a.size?1+3*Math.log(a.size):4}).attr("fill",function(a){return a.tagged?p(a.tagged):void 0}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.root.node").append("svg:circle").attr("r",function(a){return a.size?1+3*Math.log(a.size):4}).attr("fill","steelblue").attr("stroke","#369").attr("stroke-width","2px")},Phyloshow=function(a){function k(){j.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),j.selectAll("path.link").attr("stroke-width",2/h.scale())}var b=$(document).height();9*g>$(document).height()&&(b=9*g);var c=$(document).width(),d=b,f=d3.layout.cluster().size([d,c]).sort(function(a){return a.children?a.children.length:-1}).children(function(a){return a.children}),h=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",k),i=Phylodiag(),j=d3.select("body").append("svg:svg").attr("width",c+300).attr("height",d+50).attr("class","overlay").call(h).append("svg:g").attr("transform","translate(20, 20)"),a=f(a);s(a,c),j.selectAll("path.link").data(f.links(a)).enter().append("svg:path").attr("class","link").attr("d",i).attr("fill","none").attr("stroke","#383838").attr("stroke-width","2px"),j.selectAll("g.node").data(a).enter().append("svg:g").attr("class",function(a){return a.children?0==a.depth?"root node":"inner node":"leaf node"}).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).on("mouseover",function(a){if(1===e){var b="";if(a.inside.length>0){for(var c=w(a.inside),d=0;d<c[0].length;d++)b=b+c[0][d]+":\n"+c[1][d]+"<br>";p.transition().duration(200).style("opacity",.9),p.html(b).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}}else 0===e&&(p.transition().duration(200).style("opacity",.9),p.html(a.cnames).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){p.transition().duration(500).style("opacity",0)});var p=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);return PhyloNodes(j),j.selectAll("g.inner.node").append("svg:text").attr("dx",-6).attr("dy",-6).attr("text-anchor","end").attr("font-size","5").attr("fill","#606060 ").text(function(a){return a.name}),j.selectAll("g.leaf.node").append("svg:text").attr("dx",8).attr("dy",3).attr("text-anchor","start").attr("font-size","7").attr("fill",function(){return"black"}).text(function(a){return a.name}),{tree:f,vis:j}},Phyloshow(o)})})}function l(){var c="treegenplot.html?";c=c+"tree="+a+"&"+"corte="+b+"&"+"op="+"0"+"&"+"csv="+d+"&"+"fsa="+e,$(location).attr("href",c),window.location=c}function m(){var c="treeclus.html?";c=c+"tree="+a+"&"+"corte="+b+"&"+"csv="+d+"&"+"fsa="+e+"&"+"virus="+f,$(location).attr("href",c),window.location=c}var g=0,h=[];d3.select("#toggler").on("click",i),d3.csv("file://"+d,function(a){keys=Object.keys(a[0]),select=document.getElementById("countries"),select1=document.getElementById("countries1");for(key in keys)select.add(new Option(keys[key])),select1.add(new Option(keys[key]))});var j=[];$(document).ready(function(){$("#btnSubmit1").click(function(){var a=$("#frm1 select");ci=0,a.each(function(){$(this).val()&&"Load"!==$(this).val()&&"3"!==$(this).val()&&(j[ci]=$(this).val(),ci++)}),d3.select("body").selectAll("svg").remove(),g=0,k(1),i()})}),d3.select("#saveimage").on("click",m),k(0)}
