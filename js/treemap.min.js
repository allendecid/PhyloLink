function makemap(a,b){function l(){var a=d3.select("#hiddinx");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function n(){d3.csv("file://"+b,function(b){d3.text("file://"+a,function(a){function p(a,b,c){return a.replace(new RegExp(q(b),"g"),c)}function q(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function r(a,b){var c=function(a,b){if(b(a),a.children)for(var d=a.children.length-1;d>=0;d--)c(a.children[d],b)};c(a[0],function(a){a.rootDist=(a.parent?a.parent.rootDist:0)+(a.branchlength||0)});var d=a.map(function(a){return a.rootDist}),e=d3.scale.linear().domain([0,d3.max(d)]).range([0,b]);return c(a[0],function(a){a.y=e(a.rootDist)}),e}function t(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(s).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(s)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("font-size","9").attr("font-family","sans-serif").attr("fill","#fff").attr("text-anchor","middle").text(function(a){return a.key})}function u(a){function b(a,c){a.children?(a.pais=v(a),a.children.forEach(function(d){a.ltotal=a.branchlength+c,b(d,a.ltotal)})):(e+=2,a.pais=f[a.name],a.ltotal=a.branchlength+c)}return b(a,0),a}function v(a){function d(a,e){a.children?(e+=a.branchlength,a.children.forEach(function(a){d(a,e)})):(b=e+a.branchlength,c.push([b,f[a.name]]))}var b=0,c=[];return d(a,0),c.sort(function(a,b){return d3.ascending(a[0],b[0])}),c[0][1]}function y(){var a=d3.select("#barrah");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function z(){var a=d3.select("#esconde");"visible"==a.style("visibility")?a.style("visibility","hidden"):a.style("visibility","visible")}b.forEach(function(a){f[a[k[0]]]=a[k[1]],a.close=+a.close}),j=d3.map(b,function(a){return a.Country}).keys();var c=a,d=p(c," ",""),g=nwk.parser.parse(d),i=nwk.converter.toBinary(g),l=nwk.converter.toJSON(i),m=p(l,',"children":[]',""),n=JSON.parse(m);n=u(n),PhyloAng=function(){function c(c){var e=c.source,f=c.target,i=((e.x+f.x)/2,(e.y+f.y)/2,[e,{x:f.x,y:e.y},f]);return i=i.map(a),b(i)}var a=function(a){return[a.y,a.x]},b=function(a){return"M"+a[0]+" "+a[1]+" "+a[2]};return c.projection=function(b){return arguments.length?(a=b,c):a},c.path=function(a){return arguments.length?(b=a,c):b},c},Phylocor=function(a,b){var c=2*Math.PI,d=c/4,e=a[0]>=0?a[1]>=0?1:2:a[1]>=0?4:3,f=Math.abs(Math.asin(a[1]/b));switch(e){case 1:coordAngle=d-f;break;case 2:coordAngle=d+f;break;case 3:coordAngle=2*d+d-f;break;case 4:coordAngle=3*d+f}return coordAngle},Phylonodes=function(a){a.selectAll("g.leaf.node").append("svg:circle").attr("r",5).attr("fill",function(a){return h(a.pais)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.inner.node").append("svg:circle").attr("r",3.5).attr("fill",function(a){return h(a.pais)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.root.node").append("svg:circle").attr("r",6).attr("fill",function(a){return h(a.pais)}).attr("stroke","#369").attr("stroke-width","2px")},Phylodo=function(a){function k(){j.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),j.selectAll("path.link").attr("stroke-width",1.5/g.scale())}var b=$(document).height();9*e>$(document).height()&&(b=9*e);var c=$(document).width(),d=b,f=d3.layout.cluster().size([d,c]).sort(function(a){return a.children?a.children.length:-1}).children(function(a){return a.children}),g=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",k),i=PhyloAng(),j=d3.select("#arbol").append("svg:svg").attr("width",c+300).attr("height",d+50).attr("class","overlay").call(g).append("svg:g").attr("transform","translate(20, 20)"),a=f(a);return r(a,c),j.selectAll("path.link").data(f.links(a)).enter().append("svg:path").attr("class","link").attr("d",i).attr("stroke",function(a){return h(a.source.pais)}).attr("stroke-width","1.5px"),j.selectAll("g.node").data(a).enter().append("svg:g").attr("class",function(a){return a.children?0==a.depth?"root node":"inner node":"leaf node"}).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}),Phylonodes(j),j.selectAll("g.inner.node").append("svg:text").attr("dx",-6).attr("dy",-6).attr("text-anchor","end").attr("font-size","5").attr("fill","#606060 ").text(function(a){return a.name}),j.selectAll("g.leaf.node").append("svg:text").attr("dx",8).attr("dy",3).attr("text-anchor","start").attr("font-size","7").attr("fill",function(){return"black"}).text(function(a){return a.name}),{tree:f,vis:j}},Phylodo(n);var s={"":"Transparent"};for(x=0;x<j.length;x++)s[j[x]]=h(j[x]);t();var x=0;$(document).ready(function(){$("#btnSubmitm").click(function(){d3.select("#arbol").selectAll("svg").remove(),y(),o(n),z()}),$("#btnSubmitm1").click(function(){window.location.reload(!0)})})})})}function o(a){var b={},c={},d=[];for(i=0;i<j.length;i++)g[j[i]]=0,c[j[i]]=h(j[i]);c.defaultFill="#bdbdbd",d3.csv("./uploads/Countrycode.csv",function(e){function n(a){function e(a){if(a.children){g[a.pais]+=1;var f=o(a);"undefined"!=typeof f&&(c.push({origin:{latitude:b[a.pais][0],longitude:b[a.pais][1]},destination:{latitude:b[f][0],longitude:b[f][1]},options:{strokeColor:h(a.pais)},pais:a.pais,dist:a.ltotal}),l.push({name:a.pais,latitude:b[f][0],longitude:b[f][1],radius:15,fillKey:a.pais,dist:a.ltotal})),a.children.forEach(function(a){e(a)})}else g[a.pais]+=1,d.push({A:a.ltotal,B:a.pais})}var c=[];return e(a),c}function o(a){function c(a){a.children&&a.children.forEach(function(c){a.pais!==c.pais&&(b=c.pais)})}var b;return c(a),b}function q(){for(i=0;i<j.length;i++)p[j[i]]=0}function B(a){d3.select("#nRadius-value").text(m[a-1].dist.toFixed(5)),y.arc(m.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(l.slice(0,a)),a<m.length&&window.setTimeout(function(){B(++a)},m[a-1].dist*A/z)}function C(a){d3.select("#nRadius-value1").text((v*a).toFixed(5)),y.bubbles(s.slice(0,a*j.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}}),a<s.length/j.length&&window.setTimeout(function(){C(++a)},200)}function D(a){0!==a?(d3.select("#nRadius-value").text(m[a-1].dist.toFixed(5)),y.arc(m.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(l.slice(0,a))):y.arc([])}function E(a){d3.select("#nRadius-value1").text((v*a).toFixed(5)),y.bubbles(s.slice(0,a*j.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}})}var f;"1"===k[2]?f="Country":"2"===k[2]?f="two":"3"===k[2]&&(f="three"),e.forEach(function(a){b[a[f]]=[a.Latitude,a.Longitude],a.close=+a.close});var l=[],m=n(a),p={},s=[];q(),d.sort(function(a,b){return a.A-b.A});var t=d[d.length-1].A,u=d[0].A,v=(t-u)/20;console.log(d.length);var w=1,x=25*j.length/d.length;d.forEach(function(a){if(a.A<=v*w)p[a.B]+=1;else for(w++,i=0;i<j.length;i++)s.push({name:j[i],latitude:b[j[i]][0],longitude:b[j[i]][1],radius:5+p[j[i]]*x,fillKey:j[i],cant:p[j[i]]})});var y=new Datamap({element:document.getElementById("arcs"),geographyConfig:{popupOnHover:!1},scope:"world",setProjection:function(a){var b=d3.geo.mercator().center([15,51]).scale(800).translate([a.offsetWidth/2,a.offsetHeight/2]),c=d3.geo.path().projection(b);return{path:c,projection:b}},fills:c,done:function(a){function b(){a.svg.selectAll("g").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}a.svg.call(d3.behavior.zoom().on("zoom",b))}});m.sort(function(a,b){return a.dist-b.dist}),l.sort(function(a,b){return a.dist-b.dist}),$("#nRadius").attr("min",0),$("#nRadius").attr("max",m.length+1);var z=d3.max(m,function(a){return+a.dist}),A=150*m.length;console.log(m.length),console.log(l.length),$(document).ready(function(){$("#play").click(function(){B(1)}),$("#play1").click(function(){C(1)})}),d3.select("#nRadius").on("input",function(){D(+this.value)}),d3.select("#nRadius1").on("input",function(){E(+this.value)})})}var c,j,e=0,f=[],g=[],h=d3.scale.category20(),k=[];d3.csv("file://"+b,function(a){c=Object.keys(a[0]),select=document.getElementById("countries"),select1=document.getElementById("countries1");for(key in c)select.add(new Option(c[key])),select1.add(new Option(c[key]));$(document).ready(function(){$("#btnSubmit1").click(function(){var a=$("#frm2 select");ci=0,a.each(function(){$(this).val()&&"Start"!==$(this).val()&&"3"!==$(this).val()&&(k[ci]=$(this).val(),ci++)}),n(),l()})})})}
