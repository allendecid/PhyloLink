function makemap(a,b){function k(){var a=d3.select("#hiddinx");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function m(){d3.csv("uploads/"+b,function(b){d3.text("uploads/"+a,function(a){function s(a,b,c){return a.replace(new RegExp(t(b),"g"),c)}function t(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function u(a,b){var c=function(a,b){if(b(a),a.children)for(var d=a.children.length-1;d>=0;d--)c(a.children[d],b)};c(a[0],function(a){a.rootDist=(a.parent?a.parent.rootDist:0)+(a.branchlength||0)});var d=a.map(function(a){return a.rootDist}),e=d3.scale.linear().domain([0,d3.max(d)]).range([0,b]);return c(a[0],function(a){a.y=e(a.rootDist)}),e}function w(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(v).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(v)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("font-size","9").attr("font-family","sans-serif").attr("fill","#fff").attr("text-anchor","middle").text(function(a){return a.key})}function y(a){function b(a){a.children&&(a.children.reverse(),a.state.length>1&&(a.state=a.state.concat(a.children[0].state,a.children[1].state),1===H(a.state)?(a.p=2/a.state.length,a.state=[J(a.state)]):a.p=1/a.state.length),a.children.forEach(function(a){b(a)}))}return b(a),a}function z(a){function b(a){a.children&&(a.children.reverse(),a.children.forEach(function(c){c.state.length>1&&1===a.state.length&&(c.state=a.state),b(c)}))}return b(a),a}function A(a){function b(a){a.children&&a.children.forEach(function(c){c.state.length>1&&(c.state=c.state.concat(a.state),1===H(c.state)?(c.p=2/c.state.length,c.state=[J(c.state)]):c.p=1/c.state.length),b(c)})}return b(a),a}function B(a){function b(a){a.children&&a.children.forEach(function(c){if(c.state.length>1){if(a.state.length>2)for(var d=0;d<a.state.length;d++)a.weight[d]+=c.branchlength;else a.weight=c.branchlength;if(c.state=c.state.concat(a.state),c.weight=c.weight.concat(a.weight),1===H(c.state)){var e=J(c.state),f=c.state.indexOf(e),g=c.state.indexOf(e,f+1),h=(c.weight[f]+c.weight[g])/2/2,d=c.weight.indexOf(Math.min.apply(Math,c.weight));c.weight[d]<h?(c.state=[c.state[d]],c.p=h-c.weight[d],c.weight=[c.branchlength]):(c.state=[e],c.p=c.weight[d]-h,c.weight=[c.branchlength])}else{var d=c.weight.indexOf(Math.min.apply(Math,c.weight));c.state=[c.state[d]],c.weight.sort(d3.ascending),c.p=c.weight[1]-c.weight[0],c.weight=[c.branchlength]}}b(c)})}return b(a),a}function C(a,b,c){return a.children?(a.depth=b,a.weight=[a.branchlength],a.ltotal=a.branchlength+c,a.children.forEach(function(c){C(c,b+1,a.ltotal)})):(d+=2,a.depth=b,q.push(b),a.state=[e[a.name]],a.ltotal=a.branchlength+c,a.p=1,a.weight=[a.branchlength]),a}function D(a,b){if(a.children)if(a.depth===b-1){a.children.reverse();var c=G(a);a.state=c[0],a.weight=c[1],a.p=c[2]}else a.children.forEach(function(a){D(a,b)});return a}function E(a,b){if(a.children)if(a.depth===b-1){var c=F(a);a.state=c[0],a.p=c[1]}else a.children.forEach(function(a){E(a,b)});return a}function F(a){var c,b=[];return b=a.children[0].state.concat(a.children[1].state),1===H(b)?(c=2/b.length,b=[J(b)]):c=1/b.length,[b,c]}function G(a){var b=[],c=[],d=0;if(b=a.children[0].state.concat(a.children[1].state),c=a.children[0].weight.concat(a.children[1].weight),1===H(b)&&b.length>2){var e=J(b),f=b.indexOf(e),g=b.indexOf(e,f+1),h=(c[f]+c[g])/2/2,i=c.indexOf(Math.min.apply(Math,c));c[i]<h?(b=[b[i]],d=h-c[i],c=[a.branchlength]):(b=[e],d=c[i]-h,c=[a.branchlength])}else if(1===H(b)&&b.length<3)b=[J(b)],c=[a.branchlength],d=Math.max.apply(Math,[a.children[0].branchlength,a.children[1].branchlength]);else for(var i=0;i<c.length;i++)c[i]+=a.branchlength;return[b,c,d]}function H(a){for(var b=0,c=[],d=0;d<=a.length;d++)for(var e=d;e<=a.length;e++)d!=e&&a[d]==a[e]&&(b+=1,c.push(a[d]));return I(c)?1:b}function I(a){for(var b=0;b<=a.length;b++)for(var c=b;c<=a.length;c++)if(b!=c&&a[b]==a[c])return!0;return!1}function J(a){if(0==a.length)return null;for(var b={},c=a[0],d=1,e=0;e<a.length;e++){var f=a[e];null==b[f]?b[f]=1:b[f]++,b[f]>d&&(c=f,d=b[f])}return c}function O(){var a=d3.select("#barrah");"hidden"==a.style("visibility")?a.style("visibility",""):a.style("visibility","hidden")}function P(){var a=d3.select("#esconde");"visible"==a.style("visibility")?a.style("visibility","hidden"):a.style("visibility","visible")}b.forEach(function(a){e[a[j[0]]]=a[j[1]],a.close=+a.close}),h=d3.map(b,function(a){return a[j[1]]}).keys();var c=a,f=s(c," ",""),i=nwk.parser.parse(f),k=nwk.converter.toBinary(i),l=nwk.converter.toJSON(k),m=s(l,',"children":[]',""),p=JSON.parse(m),q=[];PhyloAng=function(){function c(c){var e=c.source,f=c.target,i=((e.x+f.x)/2,(e.y+f.y)/2,[e,{x:f.x,y:e.y},f]);return i=i.map(a),b(i)}var a=function(a){return[a.y,a.x]},b=function(a){return"M"+a[0]+" "+a[1]+" "+a[2]};return c.projection=function(b){return arguments.length?(a=b,c):a},c.path=function(a){return arguments.length?(b=a,c):b},c},Phylocor=function(a,b){var c=2*Math.PI,d=c/4,e=a[0]>=0?a[1]>=0?1:2:a[1]>=0?4:3,f=Math.abs(Math.asin(a[1]/b));switch(e){case 1:coordAngle=d-f;break;case 2:coordAngle=d+f;break;case 3:coordAngle=2*d+d-f;break;case 4:coordAngle=3*d+f}return coordAngle},Phylonodes=function(a){a.selectAll("g.leaf.node").append("svg:circle").attr("r",5).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.inner.node").append("svg:circle").attr("r",3.5).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px"),a.selectAll("g.root.node").append("svg:circle").attr("r",6).attr("fill",function(a){return a.state.length>1?"#ccc":g(a.state)}).attr("stroke","#369").attr("stroke-width","2px")},Phylodo=function(a,b,c){function p(){o.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),o.selectAll("path.link").attr("stroke-width",1.5/m.scale())}q=[];var e=C(a,1,0),f=d3.max(q);if(0===b){a.ltotal=0;for(var h=f;h>0;h--)var a=E(e,h);a=A(a),$("#btnSubmitm1").html("Weighted")}else{a.ltotal=0;for(var h=f;h>0;h--)var a=D(e,h);a=B(a),a.state.length>1&&(a.children[0].branchlength<a.children[1].branchlength?(a.state=a.children[0].state,a.p=a.children[1].branchlength-a.children[0].branchlength):(a.state=a.children[1].state,a.p=a.children[0].branchlength-a.children[1].branchlength)),$("#btnSubmitm1").html("Linear")}1===c&&z(a),2===c&&y(a);var i=$(document).height();9*d>$(document).height()&&(i=9*d);var j=$(document).width(),k=i,l=d3.layout.cluster().size([k,j]).sort(function(a){return a.children?a.children.length:-1}).children(function(a){return a.children}),m=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",p),n=PhyloAng(),o=d3.select("#arbol").append("svg:svg").attr("width",j+300).attr("height",k+50).attr("class","overlay").call(m).append("svg:g").attr("transform","translate(20, 20)"),a=l(a);u(a,j),o.selectAll("path.link").data(l.links(a)).enter().append("svg:path").attr("class","link").attr("d",n).attr("stroke",function(a){return a.target.state.length>1?"#ccc":g(a.target.state)}).attr("stroke-width","1.5px"),o.selectAll("g.node").data(a).enter().append("svg:g").attr("class",function(a){return a.children?0==a.depth?"root node":"inner node":"leaf node"}).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).on("mouseover",function(a){w.transition().duration(200).style("opacity",.9),w.html("State: "+a.state+"<br >"+"P: "+a.p.toFixed(3)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){w.transition().duration(500).style("opacity",0)});var w=d3.select("#arbol").append("div").attr("class","tooltip").style("opacity",0);return Phylonodes(o),o.selectAll("g.inner.node").append("svg:text").attr("dx",-6).attr("dy",-6).attr("text-anchor","end").attr("font-size","5").attr("fill","#606060 ").text(function(a){return a.name}),o.selectAll("g.leaf.node").append("svg:text").attr("dx",8).attr("dy",3).attr("text-anchor","start").attr("font-size","7").attr("fill",function(){return"black"}).text(function(a){return a.name}),{tree:l,vis:o}},Phylodo(p,0,0);var v={"":"Transparent",undefined:"#ccc"};for(N=0;N<h.length;N++)v[h[N]]=g(h[N]);w();var N=0;$(document).ready(function(){$("#btnSubmitm").click(function(){d3.select("#arbol").selectAll("svg").remove(),O(),n(p),P()}),$("#btnSubmitm1").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,"Weighted"===$(this).text()?Phylodo(p,1,0):Phylodo(p,0,0)}),$("#btnSubmitm2").click(function(){window.location.reload(!0)}),$("#btnSubmitm3").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,Phylodo(p,0,1)}),$("#btnSubmitm4").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,Phylodo(p,0,2)}),$("#btnSubmitm5").click(function(){d3.select("#arbol").selectAll("svg").remove(),d=0,O(),o(p),P()})})})})}function n(a){var b={},c={},d=[];for(i=0;i<h.length;i++)f[h[i]]=[],c[h[i]]=g(h[i]);c.defaultFill="#bdbdbd",d3.csv("uploads/Countrycode.csv",function(e){function m(a){function e(a){if(a.children){var f=n(a);if("undefined"!=typeof f)for(i=0;i<f.length;i++)f[i]!==a.state[0]&&(c.push({origin:{latitude:b[a.state][0],longitude:b[a.state][1]},destination:{latitude:b[f[i]][0],longitude:b[f[i]][1]},options:{strokeColor:g(a.state)},pais:a.state,dist:a.ltotal}),k.push({name:a.state,latitude:b[f[i]][0],longitude:b[f[i]][1],radius:15,fillKey:a.state,dist:a.ltotal}));a.children.forEach(function(a){e(a)})}else d.push({A:a.ltotal,B:a.state})}var c=[];return e(a),c}function n(a){function c(a){a.children&&a.children.forEach(function(c){a.state.length<2&&a.state!==c.state&&(b=b.concat(c.state))})}var b=[];return c(a),b}function p(){for(i=0;i<h.length;i++)o[h[i]]=0}function B(a){d3.select("#nRadius-value").text(l[a-1].dist.toFixed(5)),y.arc(l.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(k.slice(0,a)),a<l.length&&window.setTimeout(function(){B(++a)},l[a-1].dist*A)}function C(a){d3.select("#nRadius-value1").text((s+t*a).toFixed(5)),y.bubbles(q.slice(0,a*h.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}}),a<q.length/h.length&&window.setTimeout(function(){C(++a)},300)}function D(a){0!==a?(d3.select("#nRadius-value").text(l[a-1].dist.toFixed(5)),y.arc(l.slice(0,a),{strokeWidth:4,arcSharpness:3}),y.bubbles(k.slice(0,a))):y.arc([])}function E(a){d3.select("#nRadius-value1").text((s+t*a).toFixed(3)),y.bubbles(q.slice(0,a*h.length),{popupTemplate:function(a,b){return"<div class='hoverinfo'>Country "+b.name+"<br> "+"Total Individuals: "+b.cant}})}var f;"1"===j[2]?f="Country":"2"===j[2]?f="two":"3"===j[2]&&(f="three"),e.forEach(function(a){b[a[f]]=[a.Latitude,a.Longitude],a.close=+a.close});var k=[],l=m(a),o={},q=[];p(),d.sort(function(a,b){return a.A-b.A});var r=d[d.length-1].A,s=d[0].A,t=(r-s)/40,u=1,v=25*h.length/d.length;d.forEach(function(a){if(a.A<=s+t*u)o[a.B]+=1;else for(u++,i=0;i<h.length;i++)q.push({name:h[i],latitude:b[h[i]][0],longitude:b[h[i]][1],radius:5+o[h[i]]*v,fillKey:h[i],cant:o[h[i]]})});var w=0,x=0;k.forEach(function(a){w+=parseInt(a.latitude),x+=parseInt(a.longitude)}),w/=k.length,x/=k.length;var y=new Datamap({element:document.getElementById("arcs"),geographyConfig:{popupOnHover:!1},scope:"world",setProjection:function(a){var b=d3.geo.mercator().center([x,w]).scale(500).translate([a.offsetWidth/2,a.offsetHeight/2]),c=d3.geo.path().projection(b);return{path:c,projection:b}},fills:c,done:function(a){function b(){a.svg.selectAll("g").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}a.svg.call(d3.behavior.zoom().on("zoom",b))}});l.sort(function(a,b){return a.dist-b.dist}),k.sort(function(a,b){return a.dist-b.dist}),$("#nRadius").attr("min",0),$("#nRadius").attr("max",l.length),$("#nRadius1").attr("max",q.length/h.length);var z=d3.max(l,function(a){return+a.dist}),A=1e3/z;$(document).ready(function(){$("#play").click(function(){B(1)}),$("#play1").click(function(){C(1)})}),d3.select("#nRadius").on("input",function(){D(+this.value)}),d3.select("#nRadius1").on("input",function(){E(+this.value)})})}function o(a){function s(a){function c(a,d,e){a.children&&(a.code="papa",a.children.forEach(function(a){a.con=[],a.branchlength+=e,a.con=a.state,b.push(a),c(a,d+1,a.branchlength)})),a.depth=d}var b=[];return c(a,1,0),b}$("p").hide(),a=s(a),a.sort(function(a,b){return d3.ascending(a.branchlength,b.branchlength)});var c=[],d=[],e=[];h.forEach(function(a){c[a]=0,d[a]=0,e[a]=0});var f=[];a.forEach(function(a){f.push(a.branchlength);for(var b=0;b<a.con.length;b++)d[a.con[b]]+=1,c[a.con[b]]=(a.ltotal-e[a.con[b]])*d[a.con[b]]*((d[a.con[b]]-1)/2),e[a.con[b]]=a.ltotal,a.y=c[a.con[b]]});var i={top:20,right:80,bottom:30,left:150},j=900-i.left-i.right,k=500-i.top-i.bottom,l=d3.scale.linear().range([0,j]),m=d3.scale.linear().range([k,0]),n=d3.svg.axis().scale(l).orient("bottom"),o=d3.svg.axis().scale(m).orient("left"),p=d3.svg.line().interpolate("step-before").x(function(a){return l(a.date)}).y(function(a){return m(a.temp)}),q=d3.select("#arbol").append("svg").attr("width",j+i.left+i.right).attr("height",k+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")");data=a.map(function(a){return{city:a.con,date:a.branchlength,temp:a.y}}),data=d3.nest().key(function(a){return a.city}).entries(data),l.domain([0,d3.max(data,function(a){return d3.max(a.values,function(a){return a.date})})]),m.domain([0,d3.max(data,function(a){return d3.max(a.values,function(a){return a.temp})})]),q.append("g").attr("class","x axis").attr("transform","translate(0,"+k+")").call(n).append("text").attr("x",j).attr("y",30).style("text-anchor","end").text("Distance"),q.append("g").attr("class","y axis").call(o).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Count");var r=q.selectAll(".city").data(data,function(a){return a.key}).enter().append("g").attr("class","city");r.append("path").attr("class","line").attr("d",function(a){return p(a.values)}).style("stroke",function(a){return g(a.key)})}var c,h,d=0,e=[],f=[],g=d3.scale.category20(),j=[];d3.csv("uploads/"+b,function(a){c=Object.keys(a[0]),select=document.getElementById("countries"),select1=document.getElementById("countries1");for(key in c)select.add(new Option(c[key])),select1.add(new Option(c[key]));$(document).ready(function(){$("#btnSubmit1").click(function(){var a=$("#frm2 select");ci=0,a.each(function(){$(this).val()&&"Start"!==$(this).val()&&"3"!==$(this).val()&&(j[ci]=$(this).val(),ci++)}),m(),k()})})})}
