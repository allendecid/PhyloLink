function Clustree(a,b,c,d,e){function z(a){return a.size?"_g_"+a.group:a.name}function A(a){var b=z(a.source),c=z(a.target);return c>b?b+"|"+c:c+"|"+b}function B(a){return a.group}function C(a,b,c,d){d=d||{};var e={},f={},g={},h={},i={},j=[],k=[];b&&b.nodes.forEach(function(a){var d,b=c(a);a.size>0?(h[b]=a,a.size=0):(d=i[b]||(i[b]={x:0,y:0,count:0}),d.x+=a.x,d.y+=a.y,d.count+=1)});for(var l=0;l<a.length;++l){var m=a[l],n=c(m),o=e[n]||(e[n]=h[n])||(e[n]={group:n,size:0,nodes:[]});d[n]?(f[m.name]=j.length,j.push(m),h[n]&&(m.x=h[n].x+Math.random(),m.y=h[n].y+Math.random())):(0==o.size&&(f[n]=j.length,j.push(o),i[n]&&(o.x=i[n].x/i[n].count,o.y=i[n].y/i[n].count)),o.nodes.push(m)),o.size+=1,m.group_data=o}for(n in e)e[n].link_count=0;for(l=0;l<k.length;++l){var p=k[l],q=c(p.source),r=c(p.target);q!=r&&(e[q].link_count++,e[r].link_count++),q=d[q]?f[p.source.name]:f[q],r=d[r]?f[p.target.name]:f[r];var n=r>q?q+"|"+r:r+"|"+q,o=g[n]||(g[n]={source:q,target:r,size:0});o.size+=1}for(n in g)k.push(g[n]);return{nodes:j,links:k}}function D(a,b,c){for(var d={},e=0;e<a.length;++e){var f=a[e];if(!f.size){var g=b(f),h=d[g]||(d[g]=[]);h.push([f.x-c,f.y-c]),h.push([f.x-c,f.y+c]),h.push([f.x+c,f.y-c]),h.push([f.x+c,f.y+c])}}var i=[];for(g in d)i.push({group:g,path:d3.geom.hull(d[g])});return i}function E(a){return w(a.path)}function V(a){function b(a,c){a.children&&a.children.forEach(function(a){a.children&&Z(a)&&(c=1),b(a,c)}),a.change=c}return b(a,0),a}function W(a){function g(a,b,d,h){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,O.push(b+a.branchlength),g(a,0,1,a.group)):(O.push(b+a.branchlength),a.group=e,e-=1,c.push(a)):(a.group=h,N.push(b),P.push(a.group.toString()),g(a,b+a.branchlength,0,a.group))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,O.push(b+a.branchlength),g(a,0,1,a.group)):(O.push(b+a.branchlength),a.group=e,e-=1,c.push(a)):(a.group=h,N.push(b),P.push(a.group.toString()),g(a,b+a.branchlength,1,a.group))})),c.push(a)}var c=[],e=-1,f=b;return g(a,1,0,0),c}function X(a){function g(a,b,d,e){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,O.push(b+a.branchlength),g(a,0,1,a.group)):(a.group=e,N.push(b),g(a,b+a.branchlength,0,a.group)):(a.group=e,a.code="hijo",c.push(a))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,O.push(b+a.branchlength),g(a,0,1,a.group)):(a.group=e,N.push(b),g(a,b+a.branchlength,1,a.group)):(a.group=e,a.code="hijo",c.push(a))})),a.depth=b,c.push(a)}var c=[],f=b;return g(a,1,0,0),c}function Y(a){function g(a,b,d,e){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,g(a,b+1,0,a.group)):(0===a.change||a.branchlength<f?(a.group=e,a.code="hijo"):a.group=a.id,c.push(a))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,g(a,b+1,1,a.group)):(0===a.change||a.branchlength<f?(a.group=e,a.code="hijo"):a.group=a.id,c.push(a))})),a.depth=b,c.push(a)}var c=[],f=b;return g(a,1,0,0),c}function Z(a){function d(a){a.children?(b.push(a.branchlength),a.children.forEach(function(a){d(a)})):c.push(a.branchlength)}var b=[],c=[];return d(a),b>c?!0:!1}function _(a){function f(a,g){a.children?(b.push(a.branchlength+g),d.push(a.branchlength),a.children.forEach(function(b){f(b,g+a.branchlength)})):(c.push(a.branchlength+g),e.push(a.branchlength))}var b=[],c=[],d=[],e=[];return f(a,0),[b,c,d,e]}function ab(a,b,c){return a.replace(new RegExp(bb(b),"g"),c)}function bb(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function db(){var a=["name","group","branchlength"],b=d3.select("#alineax").append("table"),c=b.append("thead"),d=b.append("tbody");c.append("tr").selectAll("th").data(a).enter().append("th").text(function(a){return a});var e=d.selectAll("tr").data(l).enter().append("tr");e.selectAll("td").data(function(b){return a.map(function(a){return{column:a,value:b[a]}})}).enter().append("td").attr("style","font-family: Courier").text(function(a){return a.value})}function eb(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&++b;return b}function Cb(){xb.select(".x.axis").call(ub),xb.select(".y.axis").call(vb),xb.selectAll("path.line").attr("d",Ab),Bb.selectAll("circle").attr("transform",function(a){return"translate("+sb(a.point.x)+","+tb(a.point.y)+")"})}function Eb(){n&&n.stop(),m=C(l,m,B,k),n=d3.layout.force().nodes(m.nodes).links(m.links).size([f,g]).linkDistance(50).linkStrength(function(){return 1}).gravity(Db).charge(-5).friction(.5).start(),p.selectAll("path.hull").remove(),q=p.selectAll("path.hull").data(D(m.nodes,B,j)).enter().append("path").attr("class","hull").attr("d",E).style("fill",function(a){return x(a.group)}).on("click",function(a){console.log("hull click",a,arguments,this,k[a.group]),k[a.group]=!1,Eb()}),s=r.selectAll("line.link").data(m.links,A),s.exit().remove(),s.enter().append("line").attr("class","link").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).style("stroke-width",function(a){return a.size||1}),u=t.selectAll("circle.node").data(m.nodes,z),u.exit().remove(),u.enter().append("circle").attr("class",function(a){return"node"+(a.size?"":" leaf")}).attr("r",function(a){return a.size?a.size+h:h+1}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return x(a.group)}).on("click",function(a){console.log("node click",a,arguments,this,k[a.group]),k[a.group]=!k[a.group],Db=.01,Eb()}).on("mouseover",function(b){b.size||(a.transition().duration(200).style("opacity",.9),a.html("ID : "+b.name).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")),b.size&&(a.transition().duration(200).style("opacity",.9),a.html("Number of nodes: "+b.size).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){a.transition().duration(500).style("opacity",0)});var a=d3.select("#tree-container").append("div").attr("class","tooltip").style("opacity",0);u.call(n.drag),n.on("tick",function(){q.empty()||q.data(D(m.nodes,B,j)).attr("d",E),s.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),u.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}function Fb(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(cb).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(cb)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(a){return a.key})}function Gb(){var a=[];l.forEach(function(b){a.push(b.name+","+b.group+"\n                                    ")});var b=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(b,"table.txt")}function Hb(){d3.selectAll("svg").remove(),d3.select("#alineax").selectAll("*").remove(),Clustree(a,b,c,d,e)}function Ib(){d3.selectAll("svg").remove(),d3.select("#alineax").selectAll("*").remove(),""===c?PhyloDisplay(a,d3.csv.parse("Empty\nEmpty"),d,b,e):PhyloDisplay(a,c,d,b,e)}function Jb(){d3.selectAll("svg").remove(),d3.select("#alineax").selectAll("*").remove(),Phylogen(a,b,1,c,d,e)}function Kb(){d3.selectAll("svg").remove(),d3.select("#alineax").selectAll("*").remove(),"1"===e?Clustree(a,b,c,d,0):Clustree(a,b,c,d,1)}var l,m,n,p,q,r,s,t,u,v,f=700,g=400,h=4,j=15,k={},w=d3.svg.line().interpolate("cardinal-closed").tension(.85),x=d3.scale.category20(),F=d3.select("#tree-container"),G=F.append("svg").attr("width",f).attr("height",g),H=a,I=ab(H," ",""),J=nwk.parser.parse(I),K=nwk.converter.toBinary(J),L=nwk.converter.toJSON(K),M=ab(L,',"children":[]',"");if(v=JSON.parse(M),l=0,1===e){var N=[],O=[];l=X(v);var H=l;H=l.filter(function(a){return"hijo"!==a.code?!0:!1})}else if(0===e){var N=[],O=[],P=[];l=W(v);var H=l}else if(3===e){l=V(v),l=Y(l);var H=l;H=l.filter(function(a){return"hijo"!==a.code?!0:!1})}else{var O=[],N=[],Q=_(v),R=d3.sum(Q[2])/(Q[2].length-1),S=d3.sum(Q[3])/Q[3].length;if(R>=S){b=R,e=0,l=W(v);var H=l}else{b=R,e=1,l=X(v);var H=l;H=l.filter(function(a){return"hijo"!==a.code?!0:!1})}}var T=[];l=l.filter(function(a){return"papa"!==a.code?(T.push(a.group),!0):!1}),links=d3.layout.tree().links(l);for(var U=0;U<links.length;++U)o=links[U],o.source=links[o.source],o.target=links[o.target];p=G.append("g"),r=G.append("g"),t=G.append("g"),Eb(),G.attr("opacity",1e-6).transition().duration(1e3).attr("opacity",1);for(var cb=["steelblue","red","green","purple"],fb={},U=0;U<T.length;U++)fb[T[U]]=1+(fb[T[U]]||0);var gb={};gb.d=[{FirstName:"Cut Value",Age:b},{FirstName:"Classes",Age:eb(fb)},{FirstName:"Dunn index",Age:(d3.min(O)/d3.mean(N)).toFixed(3)}],$("#thetable tr").not(":first").not(":last").remove();for(var hb="",U=0;U<gb.d.length;U++)hb+="<tr><td>"+gb.d[U].FirstName+"</td><td>"+gb.d[U].Age+"</td></tr>";$("#thetable tr").first().after(hb),H.sort(function(a,b){return d3.descending(a.branchlength,b.branchlength)});var ib=1,jb=0,lb=[],mb=0;H.forEach(function(a,b){ib+=1,a.x=ib,jb+=a.branchlength,a.area=jb,a.y=a.branchlength,0!==mb&&lb.push({x:ib,y:mb-a.branchlength,z:1});var c=mb-a.branchlength;mb=a.branchlength,lb.length>1&&lb[lb.length-2].y>5*c&&.1>c&&(H[b-1].tag=1)});var ob=[],pb={top:20,right:30,bottom:30,left:50},f=960-pb.left-pb.right,g=350-pb.top-pb.bottom,sb=d3.scale.linear().domain([0,d3.max(H,function(a){return a.x})]).range([0,f]),tb=d3.scale.linear().domain([0,d3.max(H,function(a){return a.y})]).range([g,0]),ub=d3.svg.axis().scale(sb).tickSize(-g).tickPadding(10).tickSubdivide(!0).orient("bottom"),vb=d3.svg.axis().scale(tb).tickPadding(10).tickSize(-f).tickSubdivide(!0).orient("left"),wb=d3.behavior.zoom().x(sb).y(tb).scaleExtent([1,10]).on("zoom",Cb),xb=d3.select("#charto").append("svg").call(wb).attr("width",f+pb.left+pb.right).attr("height",g+pb.top+pb.bottom).append("g").attr("transform","translate("+pb.left+","+pb.top+")"),yb=d3.select("#charto").append("div").attr("class","tooltip").style("opacity",0);d3.svg.area().x(function(a){return sb(a.x)}).y0(g).y1(function(a){return tb(a.y)}),xb.append("g").attr("class","x axis").attr("transform","translate(0,"+g+")").call(ub),xb.append("g").attr("class","y axis").call(vb),xb.append("g").attr("class","y axis").append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("y",-pb.left+10).attr("x",-g/2).text("Distances"),xb.append("clipPath").attr("id","clip").append("rect").attr("width",f).attr("height",g),ob.push(H),ob.push(lb);var Ab=d3.svg.line().interpolate("linear").x(function(a){return sb(a.x)}).y(function(a){return tb(a.y)});xb.selectAll(".line").data(ob).enter().append("path").attr("class","line").attr("clip-path","url(#clip)").attr("stroke",function(a,b){return cb[b%cb.length]}).attr("d",Ab);var Bb=xb.selectAll(".dots").data(ob).enter().append("g").attr("class","dots").attr("clip-path","url(#clip)");Bb.selectAll(".dot").data(function(a,b){var c=[];return a.forEach(function(a){c.push({index:b,point:a})}),c}).enter().append("circle").attr("class","dot").attr("r",function(a){return a.point.tag?3:2.5}).attr("fill",function(a){return a.point.tag?"red":cb[a.index%cb.length]}).attr("transform",function(a){return"translate("+sb(a.point.x)+","+tb(a.point.y)+")"}).on("mouseover",function(a){"undefined"!=typeof a.point.area&&(yb.transition().duration(100).style("opacity",.9),yb.html(a.point.x+" Cuts <br/>"+"Explains "+(100*a.point.area/jb).toFixed(2)+" % dissimilarity <br/>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){yb.transition().duration(500).style("opacity",0)}).on("click",function(a){"undefined"!=typeof a.point.area&&(b=a.point.y,d3.select(this).style("fill","orange").attr("r",6))}),$(document).ready(function(){$("#btnSubmitm").click(function(){Hb()}),$("#btnshow").click(function(){console.log("HOLA"),$("#hiddin").toggle()}),$("#btnSubmitm1").click(function(){Ib()}),$("#btnSubmitm2").click(function(){d3.select("#alineax").selectAll("*").remove(),db()}),$("#btnSubmitm3").click(function(){Jb()}),$("#btnSubmitm4").click(function(){Kb()}),$("#btnSubmitm5").click(function(){Gb()})});var Db=.03,cb={"":"Transparent",Distance:"steelblue",Optimums:"red"};Fb()}
