function Clustree(a,b,c,d,e){function z(a){return a.size?"_g_"+a.group:a.name}function A(a){var b=z(a.source),c=z(a.target);return c>b?b+"|"+c:c+"|"+b}function B(a){return a.group}function C(a,b,c,d){d=d||{};var e={},f={},g={},h={},i={},j=[],k=[];b&&b.nodes.forEach(function(a){var d,b=c(a);a.size>0?(h[b]=a,a.size=0):(d=i[b]||(i[b]={x:0,y:0,count:0}),d.x+=a.x,d.y+=a.y,d.count+=1)});for(var l=0;l<a.length;++l){var m=a[l],n=c(m),o=e[n]||(e[n]=h[n])||(e[n]={group:n,size:0,nodes:[]});d[n]?(f[m.name]=j.length,j.push(m),h[n]&&(m.x=h[n].x+Math.random(),m.y=h[n].y+Math.random())):(0==o.size&&(f[n]=j.length,j.push(o),i[n]&&(o.x=i[n].x/i[n].count,o.y=i[n].y/i[n].count)),o.nodes.push(m)),o.size+=1,m.group_data=o}for(n in e)e[n].link_count=0;for(l=0;l<k.length;++l){var p=k[l],q=c(p.source),r=c(p.target);q!=r&&(e[q].link_count++,e[r].link_count++),q=d[q]?f[p.source.name]:f[q],r=d[r]?f[p.target.name]:f[r];var n=r>q?q+"|"+r:r+"|"+q,o=g[n]||(g[n]={source:q,target:r,size:0});o.size+=1}for(n in g)k.push(g[n]);return{nodes:j,links:k}}function D(a,b,c){for(var d={},e=0;e<a.length;++e){var f=a[e];if(!f.size){var g=b(f),h=d[g]||(d[g]=[]);h.push([f.x-c,f.y-c]),h.push([f.x-c,f.y+c]),h.push([f.x+c,f.y-c]),h.push([f.x+c,f.y+c])}}var i=[];for(g in d)i.push({group:g,path:d3.geom.hull(d[g])});return i}function E(a){return w(a.path)}function I(){n&&n.stop(),m=C(l,m,B,k),n=d3.layout.force().nodes(m.nodes).links(m.links).size([f,g]).linkDistance(50).linkStrength(function(){return 1}).gravity(H).charge(-5).friction(.5).start(),p.selectAll("path.hull").remove(),q=p.selectAll("path.hull").data(D(m.nodes,B,j)).enter().append("path").attr("class","hull").attr("d",E).style("fill",function(a){return x(a.group)}).on("click",function(a){console.log("hull click",a,arguments,this,k[a.group]),k[a.group]=!1,I()}),s=r.selectAll("line.link").data(m.links,A),s.exit().remove(),s.enter().append("line").attr("class","link").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).style("stroke-width",function(a){return a.size||1}),u=t.selectAll("circle.node").data(m.nodes,z),u.exit().remove(),u.enter().append("circle").attr("class",function(a){return"node"+(a.size?"":" leaf")}).attr("r",function(a){return a.size?a.size+h:h+1}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return x(a.group)}).on("click",function(a){console.log("node click",a,arguments,this,k[a.group]),k[a.group]=!k[a.group],H=.01,I()}).on("mouseover",function(b){b.size||(a.transition().duration(200).style("opacity",.9),a.html("ID : "+b.name).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")),b.size&&(a.transition().duration(200).style("opacity",.9),a.html("Number of nodes: "+b.size).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){a.transition().duration(500).style("opacity",0)});var a=d3.select("#tree-container").append("div").attr("class","tooltip").style("opacity",0);u.call(n.drag),n.on("tick",function(){q.empty()||q.data(D(m.nodes,B,j)).attr("d",E),s.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),u.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}function J(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(K).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(K)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(a){return a.key})}function L(){var a=d3.select("#hiddin");"visible"==a.style("visibility")?a.style("visibility","hidden"):a.style("visibility","visible")}function M(){var a=d3.select("#alineax");"hidden"==a.style("visibility")?a.style("visibility","visible"):a.style("visibility","hidden")}function N(){var f="treeclus.html?";f=f+"tree="+a+"&"+"corte="+b+"&"+"csv="+c+"&"+"fsa="+d+"&"+"virus="+e,$(location).attr("href",f),window.location=f}function O(){var f="treeclusplot.html?";f=f+"tree="+a+"&"+"corte="+b+"&"+"csv="+c+"&"+"fsa="+d+"&"+"virus="+e,$(location).attr("href",f),window.location=f}function P(){var f="treegenplot.html?";f=f+"tree="+a+"&"+"corte="+b+"&"+"op="+"1"+"&"+"csv="+c+"&"+"fsa="+d+"&"+"virus="+e,$(location).attr("href",f),window.location=f}function Q(){var f="treeclus.html?";f="1"===e?f+"tree="+a+"&"+"corte="+b+"&"+"csv="+c+"&"+"fsa="+d+"&"+"virus="+"0":f+"tree="+a+"&"+"corte="+b+"&"+"csv="+c+"&"+"fsa="+d+"&"+"virus="+"1",$(location).attr("href",f),window.location=f}function S(){var b="treelink.html?";b=b+"tree="+a+"&"+"csv="+c+"&"+"fsa="+d,$(location).attr("href",b),window.location=b}var l,m,n,p,q,r,s,t,u,v,f=700,g=400,h=4,j=15,k={},w=d3.svg.line().interpolate("cardinal-closed").tension(.85),x=d3.scale.category20(),F=d3.select("#tree-container"),G=F.append("svg").attr("width",f).attr("height",g);d3.text("file://"+a,function(a){function x(a){function b(a,c){a.children&&a.children.forEach(function(a){a.children&&B(a)&&(c=1),b(a,c)}),a.change=c}return b(a,0),a}function y(a){function g(a,b,d,h){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,k.push(b+a.branchlength),g(a,0,1,a.group)):(k.push(b+a.branchlength),a.group=e,e-=1,c.push(a)):(a.group=h,j.push(b),m.push(a.group.toString()),g(a,b+a.branchlength,0,a.group))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,k.push(b+a.branchlength),g(a,0,1,a.group)):(k.push(b+a.branchlength),a.group=e,e-=1,c.push(a)):(a.group=h,j.push(b),m.push(a.group.toString()),g(a,b+a.branchlength,1,a.group))})),c.push(a)}var c=[],e=-1,f=b;return g(a,1,0,0),c}function z(a){function g(a,b,d,e){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,k.push(b+a.branchlength),g(a,0,1,a.group)):(a.group=e,j.push(b),g(a,b+a.branchlength,0,a.group)):(a.group=e,a.code="hijo",c.push(a))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,k.push(b+a.branchlength),g(a,0,1,a.group)):(a.group=e,j.push(b),g(a,b+a.branchlength,1,a.group)):(a.group=e,a.code="hijo",c.push(a))})),a.depth=b,c.push(a)}var c=[],f=b;return g(a,1,0,0),c}function A(a){function g(a,b,d,e){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,g(a,b+1,0,a.group)):(0===a.change||a.branchlength<f?(a.group=e,a.code="hijo"):a.group=a.id,c.push(a))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.children?a.branchlength>=f?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,g(a,b+1,1,a.group)):(0===a.change||a.branchlength<f?(a.group=e,a.code="hijo"):a.group=a.id,c.push(a))})),a.depth=b,c.push(a)}var c=[],f=b;return g(a,1,0,0),c}function B(a){function d(a){a.children?(b.push(a.branchlength),a.children.forEach(function(a){d(a)})):c.push(a.branchlength)}var b=[],c=[];return d(a),b>c?!0:!1}function C(a){function f(a,g){a.children?(b.push(a.branchlength+g),d.push(a.branchlength),a.children.forEach(function(b){f(b,g+a.branchlength)})):(c.push(a.branchlength+g),e.push(a.branchlength))}var b=[],c=[],d=[],e=[];return f(a,0),[b,c,d,e]}function D(a,b,c){return a.replace(new RegExp(E(b),"g"),c)}function E(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function V(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&++b;return b}function ub(){pb.select(".x.axis").call(mb),pb.select(".y.axis").call(nb),pb.selectAll("path.line").attr("d",sb),tb.selectAll("circle").attr("transform",function(a){return"translate("+kb(a.point.x)+","+lb(a.point.y)+")"})}var c=a,d=D(c," ",""),f=nwk.parser.parse(d),g=nwk.converter.toBinary(f),h=nwk.converter.toJSON(g),i=D(h,',"children":[]',"");if(v=JSON.parse(i),l=0,"1"===e){$("h1").text("TreeClus High Div"),$("#btnSubmitm4").html("Slow Div");var j=[],k=[];l=z(v);var c=l;c=l.filter(function(a){return"hijo"!==a.code?!0:!1})}else if("0"===e){var j=[],k=[],m=[];l=y(v);var c=l}else if("3"===e){l=x(v),l=A(l);var c=l;c=l.filter(function(a){return"hijo"!==a.code?!0:!1})}else{var k=[],j=[],n=C(v),q=d3.sum(n[2])/(n[2].length-1),s=d3.sum(n[3])/n[3].length;if(console.log(q),console.log(s),q>=s){b=q,e="0",l=y(v);var c=l}else{b=q,e="1",$("h1").text("TreeClus High Div"),$("#btnSubmitm4").html("Slow Div"),l=z(v);var c=l;c=l.filter(function(a){return"hijo"!==a.code?!0:!1})}}var u=[];l=l.filter(function(a){return"papa"!==a.code?(u.push(a.group),!0):!1}),links=d3.layout.tree().links(l);for(var w=0;w<links.length;++w)o=links[w],o.source=links[o.source],o.target=links[o.target];p=G.append("g"),r=G.append("g"),t=G.append("g"),I(),G.attr("opacity",1e-6).transition().duration(1e3).attr("opacity",1);var F=["steelblue","red","green","purple"],H=["name","group","branchlength"],J=d3.select("#alineax").append("table"),K=J.append("thead"),R=J.append("tbody");K.append("tr").selectAll("th").data(H).enter().append("th").text(function(a){return a});var T=R.selectAll("tr").data(l).enter().append("tr");T.selectAll("td").data(function(a){return H.map(function(b){return{column:b,value:a[b]}})}).enter().append("td").attr("style","font-family: Courier").text(function(a){return a.value});for(var W={},w=0;w<u.length;w++)W[u[w]]=1+(W[u[w]]||0);var X={};X.d=[{FirstName:"Cut Value",Age:b},{FirstName:"Classes",Age:V(W)},{FirstName:"Dunn index",Age:(d3.min(k)/d3.mean(j)).toFixed(3)}],$("#thetable tr").not(":first").not(":last").remove();for(var Y="",w=0;w<X.d.length;w++)Y+="<tr><td>"+X.d[w].FirstName+"</td><td>"+X.d[w].Age+"</td></tr>";$("#thetable tr").first().after(Y),c.sort(function(a,b){return d3.descending(a.branchlength,b.branchlength)});var Z=1,_=0,bb=[],cb=0;c.forEach(function(a,b){Z+=1,a.x=Z,_+=a.branchlength,a.area=_,a.y=a.branchlength,0!==cb&&bb.push({x:Z,y:cb-a.branchlength,z:1});var d=cb-a.branchlength;cb=a.branchlength,bb.length>1&&bb[bb.length-2].y>5*d&&.1>d&&(c[b-1].tag=1)});var eb=[],fb={top:20,right:30,bottom:30,left:50},gb=960-fb.left-fb.right,hb=350-fb.top-fb.bottom,kb=d3.scale.linear().domain([0,d3.max(c,function(a){return a.x})]).range([0,gb]),lb=d3.scale.linear().domain([0,d3.max(c,function(a){return a.y})]).range([hb,0]),mb=d3.svg.axis().scale(kb).tickSize(-hb).tickPadding(10).tickSubdivide(!0).orient("bottom"),nb=d3.svg.axis().scale(lb).tickPadding(10).tickSize(-gb).tickSubdivide(!0).orient("left"),ob=d3.behavior.zoom().x(kb).y(lb).scaleExtent([1,10]).on("zoom",ub),pb=d3.select("#charto").append("svg").call(ob).attr("width",gb+fb.left+fb.right).attr("height",hb+fb.top+fb.bottom).append("g").attr("transform","translate("+fb.left+","+fb.top+")"),qb=d3.select("#charto").append("div").attr("class","tooltip").style("opacity",0);d3.svg.area().x(function(a){return kb(a.x)}).y0(hb).y1(function(a){return lb(a.y)}),pb.append("g").attr("class","x axis").attr("transform","translate(0,"+hb+")").call(mb),pb.append("g").attr("class","y axis").call(nb),pb.append("g").attr("class","y axis").append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("y",-fb.left+10).attr("x",-hb/2).text("Distances"),pb.append("clipPath").attr("id","clip").append("rect").attr("width",gb).attr("height",hb),eb.push(c),eb.push(bb);var sb=d3.svg.line().interpolate("linear").x(function(a){return kb(a.x)}).y(function(a){return lb(a.y)});pb.selectAll(".line").data(eb).enter().append("path").attr("class","line").attr("clip-path","url(#clip)").attr("stroke",function(a,b){return F[b%F.length]}).attr("d",sb);var tb=pb.selectAll(".dots").data(eb).enter().append("g").attr("class","dots").attr("clip-path","url(#clip)");tb.selectAll(".dot").data(function(a,b){var c=[];return a.forEach(function(a){c.push({index:b,point:a})}),c}).enter().append("circle").attr("class","dot").attr("r",function(a){return a.point.tag?3:2.5}).attr("fill",function(a){return a.point.tag?"red":F[a.index%F.length]}).attr("transform",function(a){return"translate("+kb(a.point.x)+","+lb(a.point.y)+")"}).on("mouseover",function(a){"undefined"!=typeof a.point.area&&(qb.transition().duration(100).style("opacity",.9),qb.html(a.point.x+" Cuts <br/>"+"Explains "+(100*a.point.area/_).toFixed(2)+" % dissimilarity <br/>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){qb.transition().duration(500).style("opacity",0)}).on("click",function(a){"undefined"!=typeof a.point.area&&(b=a.point.y,d3.select(this).style("fill","orange").attr("r",6))}),$(document).ready(function(){$("#btnSubmitm").click(function(){N()}),$("#btnshow").click(function(){L()}),$("#btnSubmitm1").click(function(){O()}),$("#btnSubmitm2").click(function(){M()}),$("#btnSubmitm3").click(function(){P()}),$("#btnSubmitm4").click(function(){Q()}),$("#btnSubmitm5").click(function(){S()})})});var H=.03,K={"":"Transparent",Distance:"steelblue",Optimums:"red"};J()}
