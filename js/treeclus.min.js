function Clustree(a,b){function v(a){return a.size?"_g_"+a.group:a.name}function w(a){var b=v(a.source),c=v(a.target);return c>b?b+"|"+c:c+"|"+b}function x(a){return a.group}function y(a,b,c,d){d=d||{};var e={},f={},g={},h={},i={},j=[],k=[];b&&b.nodes.forEach(function(a){var d,b=c(a);a.size>0?(h[b]=a,a.size=0):(d=i[b]||(i[b]={x:0,y:0,count:0}),d.x+=a.x,d.y+=a.y,d.count+=1)});for(var l=0;l<a.length;++l){var m=a[l],n=c(m),o=e[n]||(e[n]=h[n])||(e[n]={group:n,size:0,nodes:[]});d[n]?(f[m.name]=j.length,j.push(m),h[n]&&(m.x=h[n].x+Math.random(),m.y=h[n].y+Math.random())):(0==o.size&&(f[n]=j.length,j.push(o),i[n]&&(o.x=i[n].x/i[n].count,o.y=i[n].y/i[n].count)),o.nodes.push(m)),o.size+=1,m.group_data=o}for(n in e)e[n].link_count=0;for(l=0;l<k.length;++l){var p=k[l],q=c(p.source),r=c(p.target);q!=r&&(e[q].link_count++,e[r].link_count++),q=d[q]?f[p.source.name]:f[q],r=d[r]?f[p.target.name]:f[r];var n=r>q?q+"|"+r:r+"|"+q,o=g[n]||(g[n]={source:q,target:r,size:0});o.size+=1}for(n in g)k.push(g[n]);return{nodes:j,links:k}}function z(a,b,c){for(var d={},e=0;e<a.length;++e){var f=a[e];if(!f.size){var g=b(f),h=d[g]||(d[g]=[]);h.push([f.x-c,f.y-c]),h.push([f.x-c,f.y+c]),h.push([f.x+c,f.y-c]),h.push([f.x+c,f.y+c])}}var i=[];for(g in d)i.push({group:g,path:d3.geom.hull(d[g])});return i}function A(a){return s(a.path)}function E(){j&&j.stop(),i=y(h,i,x,g),j=d3.layout.force().nodes(i.nodes).links(i.links).size([c,d]).linkDistance(50).linkStrength(function(){return 1}).gravity(D).charge(-5).friction(.5).start(),k.selectAll("path.hull").remove(),l=k.selectAll("path.hull").data(z(i.nodes,x,f)).enter().append("path").attr("class","hull").attr("d",A).style("fill",function(a){return t(a.group)}).on("click",function(a){console.log("hull click",a,arguments,this,g[a.group]),g[a.group]=!1,E()}),n=m.selectAll("line.link").data(i.links,w),n.exit().remove(),n.enter().append("line").attr("class","link").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).style("stroke-width",function(a){return a.size||1}),q=p.selectAll("circle.node").data(i.nodes,v),q.exit().remove(),q.enter().append("circle").attr("class",function(a){return"node"+(a.size?"":" leaf")}).attr("r",function(a){return a.size?a.size+e:e+1}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return t(a.group)}).on("click",function(a){console.log("node click",a,arguments,this,g[a.group]),g[a.group]=!g[a.group],D=.01,E()}).on("mouseover",function(b){b.size||(a.transition().duration(200).style("opacity",.9),a.html("ID : "+b.name).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")),b.size&&(a.transition().duration(200).style("opacity",.9),a.html("Number of nodes: "+b.size).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){a.transition().duration(500).style("opacity",0)});var a=d3.select("#tree-container").append("div").attr("class","tooltip").style("opacity",0);q.call(j.drag),j.on("tick",function(){l.empty()||l.data(z(i.nodes,x,f)).attr("d",A),n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),q.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}function F(){var a={w:75,h:30,s:3,r:3},b=d3.select("#legend").append("svg:svg").attr("width",a.w).attr("height",d3.keys(G).length*(a.h+a.s)),c=b.selectAll("g").data(d3.entries(G)).enter().append("svg:g").attr("transform",function(b,c){return"translate(0,"+c*(a.h+a.s)+")"});c.append("svg:rect").attr("rx",a.r).attr("ry",a.r).attr("width",a.w).attr("height",a.h).style("fill",function(a){return a.value}),c.append("svg:text").attr("x",a.w/2).attr("y",a.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(a){return a.key})}var h,i,j,k,l,m,n,p,q,r,c=700,d=400,e=4,f=15,g={},s=d3.svg.line().interpolate("cardinal-closed").tension(.85),t=d3.scale.category20(),B=d3.select("#tree-container"),C=B.append("svg").attr("width",c).attr("height",d);d3.text("./uploads/"+a,function(a){function l(a){function g(a,b,d,h){0===d?a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,e-=1,c.push(a)):(a.group=0,g(a,b+1,0,a.group))})):a.children&&(a.code="papa",a.children.forEach(function(a){a.branchlength>=f?a.children?(a.group=a.id,g(a,b+1,1,a.group)):(a.group=e,e-=1,c.push(a)):(a.group=h,g(a,b+1,1,a.group))})),a.depth=b,c.push(a)}var c=[],e=-1,f=b;return g(a,1,0,0),c}function n(a,b,c){return a.replace(new RegExp(q(b),"g"),c)}function q(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function W(){R.select(".x.axis").call(O),R.select(".y.axis").call(P),R.selectAll("path.line").attr("d",U),V.selectAll("circle").attr("transform",function(a){return"translate("+M(a.point.x)+","+N(a.point.y)+")"})}var c=a,d=n(c," ",""),e=nwk.parser.parse(d),f=nwk.converter.toBinary(e),g=nwk.converter.toJSON(f),i=n(g,',"children":[]',"");r=JSON.parse(i),h=0,h=l(r);var c=h;h=h.filter(function(a){return"papa"!==a.code?!0:!1}),links=d3.layout.tree().links(h);for(var j=0;j<links.length;++j)o=links[j],o.source=links[o.source],o.target=links[o.target];k=C.append("g"),m=C.append("g"),p=C.append("g"),E(),C.attr("opacity",1e-6).transition().duration(1e3).attr("opacity",1);var s=["steelblue","red","green","purple"],t=["name","group"];console.log(t);var u=d3.select("#alinea1").append("table"),v=u.append("thead"),w=u.append("tbody");v.append("tr").selectAll("th").data(t).enter().append("th").text(function(a){return a});var x=w.selectAll("tr").data(h).enter().append("tr");x.selectAll("td").data(function(a){return t.map(function(b){return{column:b,value:a[b]}})}).enter().append("td").attr("style","font-family: Courier").text(function(a){return a.value}),c.sort(function(a,b){return d3.descending(a.branchlength,b.branchlength)});var z=1,A=0,B=[],D=0;c.forEach(function(a){z+=1,a.x=z,A+=a.branchlength,a.area=A,a.y=a.branchlength,0!==D&&B.push({x:z,y:D-a.branchlength}),D=a.branchlength});var G=[],H={top:20,right:30,bottom:30,left:50},I=960-H.left-H.right,J=350-H.top-H.bottom,M=d3.scale.linear().domain([0,d3.max(c,function(a){return a.x})]).range([0,I]),N=d3.scale.linear().domain([0,d3.max(c,function(a){return a.y})]).range([J,0]),O=d3.svg.axis().scale(M).tickSize(-J).tickPadding(10).tickSubdivide(!0).orient("bottom"),P=d3.svg.axis().scale(N).tickPadding(10).tickSize(-I).tickSubdivide(!0).orient("left"),Q=d3.behavior.zoom().x(M).y(N).scaleExtent([1,10]).on("zoom",W),R=d3.select("#charto").append("svg").call(Q).attr("width",I+H.left+H.right).attr("height",J+H.top+H.bottom).append("g").attr("transform","translate("+H.left+","+H.top+")"),S=d3.select("#charto").append("div").attr("class","tooltip").style("opacity",0);d3.svg.area().x(function(a){return M(a.x)}).y0(J).y1(function(a){return N(a.y)}),R.append("g").attr("class","x axis").attr("transform","translate(0,"+J+")").call(O),R.append("g").attr("class","y axis").call(P),R.append("g").attr("class","y axis").append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("y",-H.left+10).attr("x",-J/2).text("Dimensions"),R.append("clipPath").attr("id","clip").append("rect").attr("width",I).attr("height",J),G.push(c),G.push(B);var U=d3.svg.line().interpolate("linear").x(function(a){return M(a.x)}).y(function(a){return N(a.y)});R.selectAll(".line").data(G).enter().append("path").attr("class","line").attr("clip-path","url(#clip)").attr("stroke",function(a,b){return s[b%s.length]}).attr("d",U);var V=R.selectAll(".dots").data(G).enter().append("g").attr("class","dots").attr("clip-path","url(#clip)");V.selectAll(".dot").data(function(a,b){var c=[];return a.forEach(function(a){c.push({index:b,point:a})}),c}).enter().append("circle").attr("class","dot").attr("r",2.5).attr("fill",function(a){return s[a.index%s.length]}).attr("transform",function(a){return"translate("+M(a.point.x)+","+N(a.point.y)+")"}).on("mouseover",function(a){"undefined"!=typeof a.point.area&&(S.transition().duration(100).style("opacity",.9),S.html(a.point.x+" Dim <br/>"+(100*a.point.area/A).toFixed(2)+" % dissimilarity <br/>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"))}).on("mouseout",function(){S.transition().duration(500).style("opacity",0)}).on("click",function(a){cortador=a.point.y,d3.select(this).style("fill","red").attr("r",6)}),$(document).ready(function(){$("#btnSubmitm").click(function(){goToURL2()})}),$(document).ready(function(){$("#btnSubmitm1").click(function(){goToURL3()})}),$(document).ready(function(){$("#btnSubmitm2").click(function(){h=h.filter(function(a){return a.group>=0?!0:!1}),E()})})});var D=.03,G={"":"Transparent",Distance:"steelblue",Optimums:"red"};F()}function goToURL2(){var a="clusters.html?";a=a+"tree="+arbol+"&"+"corte="+cortador,$(location).attr("href",a),window.location=a}function goToURL3(){var a="clustertree.html?";a=0===cortador?a+"tree="+arbol+"&"+"corte="+corte:a+"tree="+arbol+"&"+"corte="+cortador,$(location).attr("href",a),window.location=a}
